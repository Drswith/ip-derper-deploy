# Deploy.sh 测试指南

本文档介绍如何使用 GitHub Actions 对 `deploy.sh` 脚本进行全面测试。

## 测试架构

我们的测试流水线包含以下几个关键组件：

### 1. GitHub Actions 工作流 (`.github/workflows/test.yml`)

自动化测试流水线，包含以下测试阶段：

#### 🔍 静态分析阶段
- **ShellCheck 语法检查**: 使用 ShellCheck 进行 shell 脚本静态分析
- **Bash 语法验证**: 验证脚本语法正确性
- **权限检查**: 确保脚本具有正确的执行权限

#### 🧪 本地测试套件
- **完整测试脚本**: 执行 test_deploy.sh 进行全面的功能测试
- **配置验证**: 测试用户输入处理和默认值设置
- **错误处理**: 验证各种错误情况的处理
- **代码质量分析**: 检查代码结构和最佳实践

#### 🖥️ 兼容性测试
- **多版本 Ubuntu 测试**: 在 Ubuntu 20.04、22.04、24.04 上测试
- **系统要求验证**: 检查 apt-get 包管理器可用性
- **环境兼容性**: 验证脚本在不同环境下的行为

#### 🔒 安全扫描
- **敏感信息检查**: 扫描硬编码的密码、密钥等
- **安全下载验证**: 确保所有下载使用 HTTPS
- **权限安全**: 检查文件权限设置

#### 📚 文档检查
- **README 存在性**: 验证项目文档完整性
- **代码注释覆盖率**: 检查代码注释质量

### 2. ShellCheck 配置 (`.shellcheckrc`)

自定义 ShellCheck 规则：
```bash
# 禁用特定规则
disable=SC1091  # 不检查sourced文件
disable=SC2034  # 允许未使用的变量

# 启用所有可选检查
enable=all
shell=bash
```

### 3. 本地测试脚本 (`test_deploy.sh`)

综合测试脚本，包含 20+ 个测试用例：
- 文件存在性和权限检查
- 语法和结构验证
- 功能逻辑测试
- 代码质量分析
- 安全检查

## 如何运行测试

### 在 GitHub Actions 中自动运行

测试会在以下情况自动触发：
- 推送到 `main` 或 `develop` 分支
- 创建 Pull Request 到 `main` 分支
- 手动触发 (workflow_dispatch)

**工作流包含以下测试任务：**
1. `shellcheck` - Shell脚本静态分析
2. `syntax-check` - Bash语法检查
3. `local-test-suite` - 本地测试套件（执行test_deploy.sh）
4. `compatibility-test` - Ubuntu多版本兼容性测试
5. `security-scan` - 安全扫描
6. `documentation-check` - 文档检查
7. `integration-test` - 集成测试汇总

### 本地运行测试

1. **运行完整测试套件**:
   ```bash
   ./test_deploy.sh
   ```

2. **运行 ShellCheck**:
   ```bash
   shellcheck deploy.sh
   ```

3. **语法检查**:
   ```bash
   bash -n deploy.sh
   ```

4. **权限检查**:
   ```bash
   chmod +x deploy.sh
   ls -la deploy.sh
   ```

## 测试用例详解

### 基础验证测试
- ✅ 脚本文件存在性
- ✅ Bash 语法正确性
- ✅ 执行权限设置
- ✅ Shebang 行检查
- ✅ 错误退出机制 (`set -e`)

### 功能逻辑测试
- ✅ Root 用户验证逻辑
- ✅ apt-get 系统检查
- ✅ Docker 安装检查
- ✅ 用户输入处理
- ✅ 默认值设置机制
- ✅ 镜像源选择逻辑

### 配置和部署测试
- ✅ docker-compose 文件生成
- ✅ 端口配置处理
- ✅ STUN 服务配置
- ✅ 客户端验证设置
- ✅ 工作目录创建
- ✅ 文件权限设置
- ✅ 服务启动命令

### 错误处理测试
- ✅ 非 root 用户运行检查
- ✅ 不支持的系统检查
- ✅ 错误退出机制
- ✅ 用户友好的错误信息

## 测试结果解读

### GitHub Actions 状态
- 🟢 **绿色**: 所有测试通过
- 🔴 **红色**: 有测试失败
- 🟡 **黄色**: 测试正在运行

### 本地测试输出
```bash
[TEST 1] 检查deploy.sh文件存在
✅ PASS

[TEST 2] Bash语法检查
✅ PASS

# ... 更多测试结果

=========================================
        测试结果汇总
=========================================

总测试数: 20
通过测试: 20
失败测试: 0

🎉 所有测试通过！deploy.sh脚本质量良好。
```

## 优化后的测试架构

### 测试整合优势
- **统一测试入口**: 通过 `local-test-suite` job 执行完整的 test_deploy.sh
- **减少冗余**: 移除了重复的模拟测试，避免测试逻辑重复
- **更好的覆盖**: 本地测试脚本提供22项详细测试用例
- **快速本地验证**: 开发者可以本地运行相同的测试套件

## 持续集成最佳实践

### 1. 测试驱动开发
- 在修改脚本前先编写测试用例
- 确保新功能有对应的测试覆盖
- 保持测试用例的更新

### 2. 代码质量保证
- 所有提交必须通过 ShellCheck 检查
- 保持良好的代码注释覆盖率
- 遵循 shell 脚本最佳实践

### 3. 安全考虑
- 定期运行安全扫描
- 避免硬编码敏感信息
- 使用 HTTPS 进行所有网络下载

### 4. 兼容性维护
- 在多个 Ubuntu 版本上测试
- 验证依赖项的可用性
- 处理不同环境的差异

## 故障排除

### 常见问题

1. **ShellCheck 警告**
   - 检查 `.shellcheckrc` 配置
   - 修复代码或添加例外规则

2. **权限问题**
   - 确保脚本有执行权限: `chmod +x deploy.sh`
   - 检查文件所有者和权限设置

3. **兼容性问题**
   - 验证在目标 Ubuntu 版本上的行为
   - 检查依赖项的可用性

4. **模拟测试失败**
   - 检查 expect 脚本的超时设置
   - 验证用户交互流程

### 调试技巧

1. **启用详细输出**:
   ```bash
   bash -x deploy.sh  # 调试模式
   ```

2. **检查特定测试**:
   ```bash
   # 只运行语法检查
   bash -n deploy.sh
   
   # 只运行 ShellCheck
   shellcheck deploy.sh
   ```

3. **查看 GitHub Actions 日志**:
   - 在 GitHub 仓库的 Actions 标签页查看详细日志
   - 下载构建产物进行本地分析

## 扩展测试

### 添加新测试用例

1. 在 `test_deploy.sh` 中添加新的测试函数
2. 在 GitHub Actions 工作流中添加新的测试步骤
3. 更新文档说明新的测试内容

### 性能测试

考虑添加以下性能测试：
- 脚本执行时间测试
- 内存使用量监控
- 网络下载速度测试

### 集成测试

可以扩展为端到端测试：
- 在真实环境中部署测试
- 验证服务的实际功能
- 测试服务的健康检查

---

通过这套完整的测试体系，我们可以确保 `deploy.sh` 脚本的质量、安全性和可靠性，为用户提供稳定的部署体验。