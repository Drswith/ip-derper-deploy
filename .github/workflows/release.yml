name: release-ip-derper

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tailscale 版本号，例如 1.90.8；留空表示使用最新版本"
        required: false
        default: ""
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: gcr.io
      IMAGE_NAME: tailscale-ip-derper
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init
        run: |
          set -euo pipefail
          echo "input.version=${{ github.event.inputs.version }}"
          echo "REGISTRY=$REGISTRY"
          echo "IMAGE_NAME=$IMAGE_NAME"
          echo "GCP_PROJECT_ID=$GCP_PROJECT_ID"

      - name: Determine Version
        id: ver
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="$(ls -d tailscale-* | head -n 1 | sed 's/tailscale-//')"
          fi
          RAW="${VERSION#v}"
          TAG="v${RAW}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "version_raw=$RAW" >> "$GITHUB_OUTPUT"
          echo "version_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION"
          echo "RAW=$RAW"
          echo "TAG=$TAG"
      
      - name: Source Fetch
        run: |
          set -euo pipefail
          VERSION="${{ steps.ver.outputs.version_tag }}"
          bash ./get-tailscale-release.sh "$VERSION"
      
      - name: Source Verify
        run: |
          set -euo pipefail
          DIR="tailscale-${{ steps.ver.outputs.version_tag }}"
          [ -d "$DIR" ] || { echo "missing $DIR"; exit 1; }
          [ -d "$DIR/cmd/derper" ] || { echo "missing derper"; exit 1; }
          [ -f "$DIR/go.mod" ] || { echo "missing go.mod"; exit 1; }
          printf "source ok: %s\n" "$DIR"

      - name: Source Patch
        run: |
          set -euo pipefail
          bash ./patch-source.sh

      - name: Patch Verify
        run: |
          set -euo pipefail
          DIR="tailscale-${{ steps.ver.outputs.version_tag }}"
          if grep -Rq 'disabled: skip' "$DIR/cmd/derper"; then
            echo "patch ok"
          else
            echo "patch not applied"
            exit 1
          fi

      - name: Docker Login GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCR_SERVICE_ACCOUNT_KEY }}

      - name: Docker Build
        run: |
          set -euo pipefail
          RAW="${{ steps.ver.outputs.version_raw }}"
          TAG="${{ steps.ver.outputs.version_tag }}"
          docker build --build-arg VERSION="$RAW" --build-arg TAILSCALE_DIR="tailscale-$TAG" -t "$IMAGE_NAME:$RAW" .

      - name: Docker Tag
        run: |
          set -euo pipefail
          RAW="${{ steps.ver.outputs.version_raw }}"
          TAG="${{ steps.ver.outputs.version_tag }}"
          docker tag "$IMAGE_NAME:$RAW" "$IMAGE_NAME:$TAG"
          docker tag "$IMAGE_NAME:$RAW" "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$RAW"
          docker tag "$IMAGE_NAME:$RAW" "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$TAG"

      - name: Docker Push
        run: |
          set -euo pipefail
          RAW="${{ steps.ver.outputs.version_raw }}"
          TAG="${{ steps.ver.outputs.version_tag }}"
          docker push "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$RAW"
          docker push "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$TAG"

      - name: Push Verify
        run: |
          set -euo pipefail
          RAW="${{ steps.ver.outputs.version_raw }}"
          TAG="${{ steps.ver.outputs.version_tag }}"
          docker pull "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$RAW"
          docker pull "gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$TAG"

      - name: Create Git Tag
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.version_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "$TAG"
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GH_REPO.git" "$TAG"
