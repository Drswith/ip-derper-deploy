name: release-ip-derper

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tailscale 版本号，例如 1.90.8；留空表示使用最新版本"
        required: false
        default: ""
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init
        run: |
          set -euo pipefail
          echo "input.version=${{ github.event.inputs.version }}"

      - name: Determine Version
        id: ver
        uses: actions/github-script@v7
        with:
          script: |
            const input = (context.payload.inputs && context.payload.inputs.version) || "";
            let tag = input.trim();
            if (tag && !tag.startsWith("v")) tag = `v${tag}`;
            if (tag) {
              try {
                await github.rest.git.getRef({ owner: "tailscale", repo: "tailscale", ref: `tags/${tag}` });
              } catch (e) {
                core.setFailed(`指定版本不存在: ${tag}`);
                return;
              }
            } else {
              const latest = await github.rest.repos.getLatestRelease({ owner: "tailscale", repo: "tailscale" });
              tag = latest.data.tag_name;
            }
            const raw = tag.startsWith("v") ? tag.slice(1) : tag;
            core.setOutput("version_tag", tag);
            core.setOutput("version_raw", raw);
            core.info(`VERSION_TAG=${tag}`);
            core.info(`VERSION_RAW=${raw}`);

      - name: Source Checkout
        uses: actions/checkout@v4
        with:
          repository: tailscale/tailscale
          ref: ${{ steps.ver.outputs.version_tag }}
          path: tailscale-${{ steps.ver.outputs.version_tag }}
          fetch-depth: 1
          persist-credentials: false

      - name: Source Verify
        run: |
          set -euo pipefail
          DIR="tailscale-${{ steps.ver.outputs.version_tag }}"
          [ -d "$DIR" ] || { echo "missing $DIR"; exit 1; }
          [ -d "$DIR/cmd/derper" ] || { echo "missing derper"; exit 1; }
          [ -f "$DIR/go.mod" ] || { echo "missing go.mod"; exit 1; }
          printf "source ok: %s\n" "$DIR"

      - name: Source Patch
        run: |
          set -euo pipefail
          bash ./patch-source.sh

      - name: Patch Verify
        run: |
          set -euo pipefail
          DIR="tailscale-${{ steps.ver.outputs.version_tag }}"
          if grep -Rq 'disabled: skip' "$DIR/cmd/derper"; then
            echo "patch ok"
          else
            echo "patch not applied"
            exit 1
          fi

      - name: Upload Source Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-src
          path: tailscale-${{ steps.ver.outputs.version_tag }}

    outputs:
      version_raw: ${{ steps.ver.outputs.version_raw }}
      version_tag: ${{ steps.ver.outputs.version_tag }}

  build-and-push:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: tailscale-ip-derper
      GHCR_NAMESPACE: ${{ github.repository_owner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: tailscale-src
          path: .

      - name: Docker Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Build
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          docker build --build-arg VERSION="$RAW" --build-arg TAILSCALE_DIR="tailscale-$TAG" -t "$IMAGE_NAME:$RAW" .

      - name: Docker Tag
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          NS=$(echo "$GHCR_NAMESPACE" | tr '[:upper:]' '[:lower:]')
          docker tag "$IMAGE_NAME:$RAW" "$IMAGE_NAME:$TAG"
          docker tag "$IMAGE_NAME:$RAW" "ghcr.io/$NS/$IMAGE_NAME:$RAW"
          docker tag "$IMAGE_NAME:$RAW" "ghcr.io/$NS/$IMAGE_NAME:$TAG"

      - name: Docker Push
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          NS=$(echo "$GHCR_NAMESPACE" | tr '[:upper:]' '[:lower:]')
          docker push "ghcr.io/$NS/$IMAGE_NAME:$RAW"
          docker push "ghcr.io/$NS/$IMAGE_NAME:$TAG"

      - name: Push Verify
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          NS=$(echo "$GHCR_NAMESPACE" | tr '[:upper:]' '[:lower:]')
          docker pull "ghcr.io/$NS/$IMAGE_NAME:$RAW"
          docker pull "ghcr.io/$NS/$IMAGE_NAME:$TAG"
