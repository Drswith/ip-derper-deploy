name: release-derper-ubuntu

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tailscale 版本号，例如 1.90.8；留空表示最新版本"
        required: false
        default: ""
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init
        run: |
          set -euo pipefail
          echo "input.version=${{ github.event.inputs.version }}"

      - name: Determine Version
        id: ver
        uses: actions/github-script@v7
        with:
          script: |
            const input = (context.payload.inputs && context.payload.inputs.version) || "";
            let tag = input.trim();
            if (tag && !tag.startsWith("v")) tag = `v${tag}`;
            if (tag) {
              try {
                await github.rest.git.getRef({ owner: "tailscale", repo: "tailscale", ref: `tags/${tag}` });
              } catch (e) {
                core.setFailed(`指定版本不存在: ${tag}`);
                return;
              }
            } else {
              const latest = await github.rest.repos.getLatestRelease({ owner: "tailscale", repo: "tailscale" });
              tag = latest.data.tag_name;
            }
            const raw = tag.startsWith("v") ? tag.slice(1) : tag;
            core.setOutput("version_tag", tag);
            core.setOutput("version_raw", raw);
            core.info(`VERSION_TAG=${tag}`);
            core.info(`VERSION_RAW=${raw}`);

      - name: Source Checkout
        uses: actions/checkout@v4
        with:
          repository: tailscale/tailscale
          ref: ${{ steps.ver.outputs.version_tag }}
          path: tailscale
          fetch-depth: 1
          persist-credentials: false

      - name: Source Verify
        run: |
          set -euo pipefail
          DIR="tailscale"
          [ -d "$DIR" ] || { echo "missing $DIR"; exit 1; }
          [ -d "$DIR/cmd/derper" ] || { echo "missing derper"; exit 1; }
          [ -f "$DIR/go.mod" ] || { echo "missing go.mod"; exit 1; }
          printf "source ok: %s\n" "$DIR"

      - name: Source Patch
        run: |
          set -euo pipefail
          shopt -s nullglob
          patched=0
          for dir in tailscale/cmd/derper; do
            [ -d "$dir" ] || continue
            for file in "$dir"/*.go; do
              [ -f "$file" ] || continue
              if grep -q 'cert mismatch with hostname' "$file" || grep -q 'cert invalid for hostname' "$file"; then
                cp "$file" "$file.bak"
                sed -i 's/return nil, fmt.Errorf("cert mismatch with hostname: %q", hi.ServerName)/\/\/ disabled: skip domain mismatch check/' "$file"
                sed -i 's/return nil, fmt.Errorf("cert invalid for hostname %q: %w", hostname, err)/\/\/ disabled: skip hostname verification/' "$file"
                patched=1
              fi
            done
          done
          if [ "$patched" -eq 1 ]; then
            echo "patch applied"
          else
            echo "no target files found"
            exit 1
          fi

      - name: Patch Verify
        run: |
          set -euo pipefail
          DIR="tailscale"
          if grep -Rq 'disabled: skip' "$DIR/cmd/derper"; then
            echo "patch ok"
          else
            echo "patch not applied"
            exit 1
          fi

      - name: Upload Source Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-src
          path: tailscale

    outputs:
      version_raw: ${{ steps.ver.outputs.version_raw }}
      version_tag: ${{ steps.ver.outputs.version_tag }}

  build:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: tailscale-src
          path: source

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Show Go env
        run: |
          set -euo pipefail
          go env

      - name: Build derper (linux/${{ matrix.arch }})
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          mkdir -p dist
          DERPER_DIR=$(find source -type d -path "*/cmd/derper" | head -n 1)
          if [ -z "$DERPER_DIR" ]; then
            echo "未找到 derper 源码目录，当前目录结构如下："
            ls -R source || true
            exit 1
          fi
          echo "使用 derper 源码目录: $DERPER_DIR"
          OUT="${GITHUB_WORKSPACE}/dist/derper-linux-${{ matrix.arch }}"
          pushd "$DERPER_DIR"
          GOOS=linux GOARCH=${{ matrix.arch }} CGO_ENABLED=0 go build -buildvcs=false -trimpath -ldflags "-s -w" -o "$OUT"
          popd
          cp LICENSE dist/ || true
          cp README.md dist/ || true

      - name: Package (linux/${{ matrix.arch }})
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          cp dist/derper-linux-${{ matrix.arch }} dist/derper
          tar -C dist -czf dist/derper_${RAW}_linux_${{ matrix.arch }}.tar.gz derper LICENSE README.md || tar -C dist -czf dist/derper_${RAW}_linux_${{ matrix.arch }}.tar.gz derper
          rm -f dist/derper
          (cd dist && sha256sum derper_${RAW}_linux_${{ matrix.arch }}.tar.gz derper-linux-${{ matrix.arch }} > SHA256SUMS_${{ matrix.arch }}.txt)

      - name: Upload Artifacts (linux/${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: derper-${{ needs.prepare.outputs.version_raw }}-linux-${{ matrix.arch }}
          path: |
            dist/derper_${{ needs.prepare.outputs.version_raw }}_linux_${{ matrix.arch }}.tar.gz
            dist/derper-linux-${{ matrix.arch }}
            dist/SHA256SUMS_${{ matrix.arch }}.txt

  publish:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: derper-*
          path: release

      - name: Aggregate checksums
        run: |
          set -euo pipefail
          RAW="${{ needs.prepare.outputs.version_raw }}"
          find release -type f -name "SHA256SUMS_*.txt" -exec cat {} \; > release/derper_${RAW}_SHA256SUMS.txt
          ls -l release

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: derper-${{ needs.prepare.outputs.version_raw }}-artifacts
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: derper-${{ needs.prepare.outputs.version_raw }}
          name: derper ${{ needs.prepare.outputs.version_raw }}
          draft: false
          prerelease: false
          files: |
            release/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
